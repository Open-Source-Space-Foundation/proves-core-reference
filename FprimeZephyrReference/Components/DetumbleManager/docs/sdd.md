# Components::DetumbleManager

The Detumble Manager component implements a B-dot style detumbling controller. It coordinates angular-velocity measurements, dipole moment commands, and magnetorquer actuation to reduce the spacecraft rotation rate. The component operates as a scheduled passive component and drives a set of configured magnetorquer coils.

## Usage Examples

The Detumble Manager is designed to be scheduled periodically to drive its internal state machine:

- **COOLDOWN** – wait for sensors and the magnetic environment to settle after a torque command
- **SENSING** – read angular velocity, compare against a configurable threshold, and decide whether detumbling is required
- **TORQUING** – command magnetorquers using a dipole moment provided by an upstream controller

### Typical Usage

1. The component is instantiated and initialized during system startup.
2. Parameters are loaded (mode, thresholds, timing, coil properties).
3. The deployment calls `configure()` in the component configuration phase to cache coil parameters and publish related telemetry.
4. The scheduler periodically calls the `run` port.
5. On each run:
   - The component checks the operating mode (DISABLED or AUTO).
   - The state machine executes COOLDOWN, SENSING, or TORQUING actions.
   - When appropriate, it requests:
     - Angular velocity via `angularVelocityGet`.
     - Dipole moment command via `dipoleMomentGet`.
   - It starts or stops the magnetorquers via the `x*/y*/z*Start` and `x*/y*/z*Stop` ports.

## Class Diagram

```mermaid
classDiagram
    namespace Components {
        class DetumbleManagerComponentBase {
            <<Auto-generated>>
        }
        class DetumbleManager {
            + DetumbleManager(const char* compName)
            + ~DetumbleManager()
            + configure(): void
            - run_handler(FwIndexType portNum, U32 context): void
            - setMode_handler(FwIndexType portNum, const DetumbleMode& mode): void
            - systemModeChanged_handler(FwIndexType portNum, const SystemMode& mode): void
            - SET_MODE_cmdHandler(FwOpcodeType opCode, U32 cmdSeq, DetumbleMode mode): void
            - startMagnetorquers(I8 x_plus, I8 x_minus, I8 y_plus, I8 y_minus, I8 z_minus): void
            - stopMagnetorquers(): void
            - stateCooldownActions(): void
            - stateEnterCooldownActions(): void
            - stateExitCooldownActions(): void
            - stateSensingActions(): void
            - stateTorquingActions(): void
            - stateEnterTorquingActions(): void
            - stateExitTorquingActions(): void
            - bdotTorqueAction(): void
            - hysteresisTorqueAction(): void
            - m_bdot: BDot
            - m_strategy_selector: StrategySelector
            - m_xPlusMagnetorquer: Magnetorquer
            - m_xMinusMagnetorquer: Magnetorquer
            - m_yPlusMagnetorquer: Magnetorquer
            - m_yMinusMagnetorquer: Magnetorquer
            - m_zMinusMagnetorquer: Magnetorquer
            - m_mode: DetumbleMode
            - m_state: DetumbleState
            - m_strategy: DetumbleStrategy
            - m_cooldownStartTime: Fw::Time
            - m_torqueStartTime: Fw::Time
        }
    }

    DetumbleManagerComponentBase <|-- DetumbleManager : inherits
    DetumbleManager "1" *-- "1" BDot
    DetumbleManager "1" *-- "1" StrategySelector
    DetumbleManager "1" *-- "5" Magnetorquer
```

### Helper Classes

#### BDot

```mermaid
classDiagram
    class BDot {
        + BDot()
        + ~BDot()
        + getDipoleMoment(magnetic_field: double[3], reading_seconds: uint32, reading_useconds: uint32, gain: double) double[3]
        - dB_dt(magnetic_field: double[3], dt_us: microseconds) double[3]
        - getMagnitude(vector: double[3]) double
        - updatePreviousReading(magnetic_field: double[3], reading: TimePoint)
        - validateTimeDelta(dt: microseconds) bool
        - m_previous_magnetic_field: double[3]
        - m_previous_magnetic_field_reading_time: TimePoint
    }
```

#### Magnetorquer

```mermaid
classDiagram
    class Magnetorquer {
        + Magnetorquer()
        + ~Magnetorquer()
        + dipoleMomentToCurrent(dipole_moment_component: double) int8
        - getCoilArea() double
        - getMaxCoilCurrent() double
        - computeTargetCurrent(dipole_moment_component: double) double
        - computeClampedCurrent(target_current: double) int8
        + PI: double
        + m_turns: double
        + m_voltage: double
        + m_resistance: double
        + m_direction_sign: DirectionSign
        + m_shape: CoilShape
        + m_width: double
        + m_length: double
        + m_diameter: double
    }
    class CoilShape {
        <<enumeration>>
        RECTANGULAR
        CIRCULAR
    }
    class DirectionSign {
        <<enumeration>>
        POSITIVE
        NEGATIVE
    }
    Magnetorquer -- CoilShape
    Magnetorquer -- DirectionSign
```

#### StrategySelector

```mermaid
classDiagram
    class StrategySelector {
        + StrategySelector()
        + ~StrategySelector()
        + fromAngularVelocity(angular_velocity: double[3]) Strategy
        + configure(bdot_max_threshold: double, deadband_upper_threshold: double, deadband_lower_threshold: double)
        - getAngularVelocityMagnitude(angular_velocity: double[3]) double
        - PI: double
        - m_bdot_max_threshold: double
        - m_deadband_lower_threshold: double
        - m_deadband_upper_threshold: double
        - m_rotation_target: double
    }
    class Strategy {
        <<enumeration>>
        IDLE
        BDOT
        HYSTERESIS
    }
    StrategySelector -- Strategy
```

## Port Descriptions

| Name             | Type         | Description                                                        |
| ---------------- | ------------ | ------------------------------------------------------------------ |
| run              | sync input   | Scheduler port that advances the detumble state machine           |
| angularVelocityGet | output     | Requests current angular velocity vector                          |
| magneticFieldGet | output       | Requests current magnetic field vector (for upstream controller)  |
| dipoleMomentGet  | output       | Requests commanded dipole moment from a detumble controller       |
| xPlusStart       | output       | Command to start the X+ magnetorquer with a signed current value  |
| xPlusStop        | output       | Command to stop the X+ magnetorquer                               |
| xMinusStart      | output       | Command to start the X− magnetorquer with a signed current value  |
| xMinusStop       | output       | Command to stop the X− magnetorquer                               |
| yPlusStart       | output       | Command to start the Y+ magnetorquer with a signed current value  |
| yPlusStop        | output       | Command to stop the Y+ magnetorquer                               |
| yMinusStart      | output       | Command to start the Y− magnetorquer with a signed current value  |
| yMinusStop       | output       | Command to stop the Y− magnetorquer                               |
| zMinusStart      | output       | Command to start the Z− magnetorquer with a signed current value  |
| zMinusStop       | output       | Command to stop the Z− magnetorquer                               |
| timeCaller       | time get     | Requests current system time for timing COOLDOWN and TORQUING     |
| logTextOut       | text event   | Sends textual events                                               |
| logOut           | event        | Sends binary events                                                |
| tlmOut           | telemetry    | Sends telemetry channels                                           |
| prmGetOut        | param get    | Retrieves parameter values                                        |
| prmSetOut        | param set    | Updates parameter values                                          |
| cmdRegOut        | command reg  | Registers commands                                                 |
| cmdIn            | command recv | Receives commands                                                  |
| cmdResponseOut   | command resp | Sends command responses                                            |

## Parameters and Telemetry (Summary)

- **Mode and thresholds**
  - `OPERATING_MODE` (DetumbleMode): DISABLED or AUTO.
  - `ROTATIONAL_THRESHOLD` (F64): Angular-velocity threshold (deg/s) for enabling torquing.
  - `COOLDOWN_DURATION` (Fw.TimeIntervalValue): Time spent waiting after a torque command.
  - `TORQUE_DURATION` (Fw.TimeIntervalValue): Duration of a single torque actuation.

- **Coil configuration (per axis/coil)**
  - Voltage, resistance, number of turns, dimensions, and shape.
  - A full set exists for X+, X−, Y+, Y−, and Z− coils.

- **Key telemetry**
  - `Mode` (DetumbleMode): Current operating mode.
  - `State` (DetumbleState): COOLDOWN, SENSING, or TORQUING.
  - `BelowRotationalThreshold` (bool): Whether the angular-velocity magnitude is currently below the threshold.
  - `RotationalThreshold`, `CooldownDuration`, `TorqueDuration`.
  - Per-coil configuration telemetry for all coils (voltage, resistance, turns, geometry, shape).

- **Events**
  - `DipoleMomentRetrievalFailed`: Logged if `dipoleMomentGet` does not succeed.
  - `AngularVelocityRetrievalFailed`: Logged if `angularVelocityGet` does not succeed.

## Sequence Diagrams

### State Machine Overview (AUTO mode)

```mermaid
sequenceDiagram
    participant Scheduler
    participant DetumbleManager
    participant AngularSource as Angular Velocity Source
    participant DipoleSource as Dipole Moment Source
    participant MTQ as Magnetorquer Drivers

    Scheduler->>DetumbleManager: run()
    alt OPERATING_MODE == DISABLED
        DetumbleManager->>MTQ: x*/y*/z*Stop
        note right of DetumbleManager: State reset to COOLDOWN
    else AUTO
        opt COOLDOWN
            DetumbleManager->>DetumbleManager: stateCooldownActions()
            DetumbleManager->>timeCaller: getTime()
            timeCaller-->>DetumbleManager: current time
            note right of DetumbleManager: Transition to SENSING after cooldown duration
        end

        opt SENSING
            DetumbleManager->>AngularSource: angularVelocityGet()
            AngularSource-->>DetumbleManager: angular velocity, status
            alt retrieval failed
                DetumbleManager->>DetumbleManager: log AngularVelocityRetrievalFailed
            else |ω| < threshold
                note right of DetumbleManager: Stay in SENSING, no torquing
            else |ω| >= threshold
                DetumbleManager->>DipoleSource: dipoleMomentGet()
                DipoleSource-->>DetumbleManager: dipole moment, status
                alt retrieval failed
                    DetumbleManager->>DetumbleManager: log DipoleMomentRetrievalFailed
                else success
                    note right of DetumbleManager: Transition to TORQUING
                end
            end
        end

        opt TORQUING
            DetumbleManager->>DetumbleManager: stateTorquingActions()
            note right of DetumbleManager: On first entry, compute coil currents
            DetumbleManager->>MTQ: x*/y*/z*Start(currents)
            DetumbleManager->>timeCaller: getTime()
            timeCaller-->>DetumbleManager: current time
            alt torque interval elapsed
                DetumbleManager->>MTQ: x*/y*/z*Stop
                note right of DetumbleManager: Transition to COOLDOWN
            end
        end
    end
```

## Requirements

| Name                        | Description                                                                                               | Validation                                                   |
| --------------------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| Mode Control                | The component shall support DISABLED and AUTO modes via `OPERATING_MODE`.                                | Parameter set and telemetry `Mode` observed over GDS.        |
| Safe Disable                | When in DISABLED mode, all magnetorquer outputs shall be turned off and the internal state reset.       | Force DISABLED, verify all `*Stop` ports are called.         |
| Threshold-Based Activation  | Detumbling shall only be performed when the measured angular-velocity magnitude exceeds the configured threshold. | Sweep angular velocity values around `ROTATIONAL_THRESHOLD` and monitor transitions to TORQUING. |
| Cooldown Timing             | After TORQUING, the component shall remain in COOLDOWN for at least `COOLDOWN_DURATION` before SENSING. | Instrument time via `timeCaller` and observe state changes.  |
| Torque Duration             | During TORQUING, magnetorquers shall be active for at most `TORQUE_DURATION` before being stopped.      | Verify `*Start` followed by `*Stop` bracket the configured interval. |
| Coil Current Limiting       | Commanded coil currents shall not exceed the maximum allowable current derived from voltage and resistance. | Inject large commanded dipole moments and inspect computed currents. |
| Parameter Telemetry         | Coil configuration parameters shall be telemetered for all coils after configuration.                   | Call `configure()` and verify coil telemetry channels.       |
| Error Reporting             | The component shall emit warning events when angular velocity or dipole moment retrieval fails.         | Force non-success return codes and observe events.           |

## Change Log

| Date       | Description                                                                 |
| ---------- | --------------------------------------------------------------------------- |
| 2025-12-20 | Initial design document drafted for Detumble Manager component             |
